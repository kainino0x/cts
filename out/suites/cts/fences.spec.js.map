{"version":3,"sources":["../../../src/suites/cts/fences.spec.ts"],"names":["description","attemptGarbageCollection","TestGroup","GPUTest","g","test","t","fence","queue","createFence","expect","getCompletedValue","initialValue","signal","onCompletion","promise","shouldReject","Promise","resolve","requestAnimationFrame","i","promises","push","then","all"],"mappings":"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","sourcesContent":["export const description = ``;\n\nimport { attemptGarbageCollection } from '../../framework/collect_garbage.js';\nimport { TestGroup } from '../../framework/index.js';\n\nimport { GPUTest } from './gpu_test.js';\n\nexport const g = new TestGroup(GPUTest);\n\ng.test('initial/no descriptor', t => {\n  const fence = t.queue.createFence();\n  t.expect(fence.getCompletedValue() === 0);\n});\n\ng.test('initial/empty descriptor', t => {\n  const fence = t.queue.createFence({});\n  t.expect(fence.getCompletedValue() === 0);\n});\n\ng.test('initial/descriptor with initialValue', t => {\n  const fence = t.queue.createFence({ initialValue: 2 });\n  t.expect(fence.getCompletedValue() === 2);\n});\n\n// Promise resolves when onCompletion value is less than signal value.\ng.test('wait/less than signaled', async t => {\n  const fence = t.queue.createFence();\n  t.queue.signal(fence, 2);\n  await fence.onCompletion(1);\n  t.expect(fence.getCompletedValue() === 2);\n});\n\n// Promise resolves when onCompletion value is equal to signal value.\ng.test('wait/equal to signaled', async t => {\n  const fence = t.queue.createFence();\n  t.queue.signal(fence, 2);\n  await fence.onCompletion(2);\n  t.expect(fence.getCompletedValue() === 2);\n});\n\n// Test it is illegal to wait on a value greater than the signaled value.\ng.test('wait/greater than signaled', async t => {\n  const fence = t.queue.createFence();\n  t.queue.signal(fence, 2);\n  const promise = fence.onCompletion(3);\n\n  await t.shouldReject('OperationError', promise);\n});\n\n// Promise resolves when signal is called multiple times.\ng.test('wait/signaled multiple times', async t => {\n  const fence = t.queue.createFence();\n  t.queue.signal(fence, 1);\n  t.queue.signal(fence, 2);\n  await fence.onCompletion(2);\n  t.expect(fence.getCompletedValue() === 2);\n});\n\n// Promise resolves if fence has already completed.\ng.test('wait/already completed', async t => {\n  const fence = t.queue.createFence();\n  t.queue.signal(fence, 2);\n\n  // Wait for value to update.\n  while (fence.getCompletedValue() < 2) {\n    await new Promise(resolve => {\n      requestAnimationFrame(resolve);\n    });\n  }\n\n  t.expect(fence.getCompletedValue() === 2);\n\n  await fence.onCompletion(2);\n  t.expect(fence.getCompletedValue() === 2);\n});\n\n// Test it is illegal to wait on a fence without signaling the value.\ng.test('wait/without signal', async t => {\n  const fence = t.queue.createFence();\n  const promise = fence.onCompletion(2);\n\n  await t.shouldReject('OperationError', promise);\n});\n\n// Test it is illegal to wait on a fence before it is signaled.\ng.test('wait/before signaled', async t => {\n  const fence = t.queue.createFence();\n  const promise = fence.onCompletion(2);\n  t.queue.signal(fence, 2);\n\n  await t.shouldReject('OperationError', promise);\n});\n\n// Test many calls to signal and wait on fence values one at a time.\ng.test('wait/many/serially', async t => {\n  const fence = t.queue.createFence();\n  for (let i = 1; i <= 20; ++i) {\n    t.queue.signal(fence, i);\n    await fence.onCompletion(i);\n    t.expect(fence.getCompletedValue() === i);\n  }\n});\n\n// Test many calls to signal and wait on all fence values.\ng.test('wait/many/parallel', async t => {\n  const fence = t.queue.createFence();\n  const promises = [];\n  for (let i = 1; i <= 20; ++i) {\n    t.queue.signal(fence, i);\n    promises.push(\n      fence.onCompletion(i).then(() => {\n        t.expect(fence.getCompletedValue() >= i);\n      })\n    );\n  }\n  await Promise.all(promises);\n  t.expect(fence.getCompletedValue() === 20);\n});\n\n// Test dropping references to the fence and onCompletion promise does not crash.\ng.test('drop/fence and promise', t => {\n  {\n    const fence = t.queue.createFence();\n    t.queue.signal(fence, 2);\n    fence.onCompletion(2);\n  }\n  attemptGarbageCollection();\n});\n\n// Test dropping references to the fence and holding the promise does not crash.\ng.test('drop/promise', async t => {\n  let promise;\n  {\n    const fence = t.queue.createFence();\n    t.queue.signal(fence, 2);\n    promise = fence.onCompletion(2);\n  }\n  attemptGarbageCollection();\n  await promise;\n});\n"],"file":"fences.spec.js"}