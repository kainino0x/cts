{"version":3,"sources":["../../src/runtime/standalone.ts"],"names":["TestLoader","Logger","makeQueryString","log","runButtonCallbacks","Map","resultsJSON","document","getElementById","resultsVis","makeTest","spec","description","test","$","addClass","appendTo","testrun","html","text","testcases","on","el","find","rc","get","textContent","asJSON","mkCase","testcasesVis","query","t","testcase","casehead","caserun","casetime","caselogs","class","runCase","res","run","timems","toFixed","removeClass","status","logs","empty","l","set","url","URL","window","location","toString","runnow","searchParams","loader","files","loadTestsFromQuery","search","runCaseList","f","id","tRec","record","g","iterate","push"],"mappings":"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","sourcesContent":["// Implements the standalone test runner (see also: index.html).\n\nimport { TestSpecID } from '../framework/id.js';\nimport { RunCase } from '../framework/index.js';\nimport { TestLoader } from '../framework/loader.js';\nimport { Logger } from '../framework/logger.js';\nimport { makeQueryString } from '../framework/url_query.js';\n\nconst log = new Logger();\n\ntype runButtonCallback = () => Promise<void>;\nconst runButtonCallbacks = new Map<HTMLElement, runButtonCallback>();\n\nconst resultsJSON = document.getElementById('resultsJSON') as HTMLElement;\nconst resultsVis = document.getElementById('resultsVis') as HTMLElement;\nfunction makeTest(spec: TestSpecID, description: string): HTMLElement {\n  const test = $('<div>')\n    .addClass('test')\n    .appendTo(resultsVis);\n\n  const testrun = $('<button>')\n    .addClass('testrun')\n    .html('&#9654;')\n    .appendTo(test);\n\n  $('<div>')\n    .addClass('testname')\n    .text(makeQueryString(spec))\n    .appendTo(test);\n\n  $('<div>')\n    .addClass('testdesc')\n    .text(description)\n    .appendTo(test);\n\n  const testcases = $('<div>')\n    .addClass('testcases')\n    .appendTo(test);\n\n  testrun.on('click', async () => {\n    for (const el of test.find('.caserun')) {\n      const rc = runButtonCallbacks.get(el) as runButtonCallback;\n      await rc();\n    }\n    resultsJSON.textContent = log.asJSON(2);\n  });\n\n  return testcases[0];\n}\n\nfunction mkCase(testcasesVis: HTMLElement, query: string, t: RunCase): () => Promise<void> {\n  const testcase = $('<div>')\n    .addClass('testcase')\n    .appendTo(testcasesVis);\n  const casehead = $('<div>')\n    .addClass('casehead')\n    .appendTo(testcase);\n\n  const caserun = $('<button>')\n    .addClass('caserun')\n    .html('&#9654;')\n    .appendTo(casehead);\n  $('<div>')\n    .addClass('casename')\n    .appendTo(casehead)\n    .text(query);\n  const casetime = $('<div>')\n    .addClass('casetime')\n    .appendTo(casehead);\n\n  const caselogs = $('<div>', { class: 'caselogs' }).appendTo(testcase);\n\n  const runCase = async () => {\n    const res = await t.run();\n\n    casetime.text(res.timems.toFixed(4) + ' ms');\n\n    testcase.removeClass('pass');\n    testcase.removeClass('warn');\n    testcase.removeClass('fail');\n    testcase.addClass(res.status);\n\n    if (res.logs) {\n      caselogs.empty();\n      for (const l of res.logs) {\n        $('<div>', { class: 'caselog' })\n          .appendTo(caselogs)\n          .text(l);\n      }\n    }\n  };\n  runButtonCallbacks.set(caserun[0], runCase);\n  caserun.on('click', async () => {\n    await runCase();\n    resultsJSON.textContent = log.asJSON(2);\n  });\n  return runCase;\n}\n\n(async () => {\n  const url = new URL(window.location.toString());\n  const runnow = url.searchParams.get('runnow') === '1';\n\n  const loader = new TestLoader();\n\n  // TODO: everything after this point is very similar across the three runtimes.\n  // TODO: start populating page before waiting for everything to load?\n  const files = await loader.loadTestsFromQuery(window.location.search);\n  // TODO: convert listing to tree so it can be displayed as a tree?\n\n  const runCaseList = [];\n  for (const f of files) {\n    const testcasesVis = makeTest(f.id, f.spec.description);\n\n    if (!('g' in f.spec)) {\n      continue;\n    }\n\n    const [tRec] = log.record(f.id);\n    for (const t of f.spec.g.iterate(tRec)) {\n      const query = makeQueryString(f.id, t.id);\n      const runCase = mkCase(testcasesVis, query, t);\n      runCaseList.push(runCase);\n    }\n  }\n\n  if (runnow) {\n    for (const runCase of runCaseList) {\n      await runCase();\n    }\n    resultsJSON.textContent = log.asJSON(2);\n  }\n})();\n"],"file":"standalone.js"}